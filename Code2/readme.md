Below is a simplified demo of how the server can introduce perturbations in the resulting ciphertext of a homomorphic gate computation by observing its timing value. Based on this timing value, the server extracts the bound of the error present in this resulting ciphertext from a template it had created during the offline phase using a key of its choice. 

For the purpose of this demo, we have created a template and a testing file. The template has been created using 10000 encryptions of the same plaintext pair and under the same key. The tesing data has been created using 3000 encryptions of randomly generated plaintext pairs under a randomly generated key.

We have provided all the necessary code along with the Dockerfile in our GitHub repository. To clone this repository and build the image locally, the following set of commands need to be run:

1. git clone https://github.com/cracking-tfhe/s_n_p_submission_2023.git 	#clones the repository locally in the current directory.

2. cd s_n_p_submission_2023/Code2/demo_code_for_with_timing_data 		#to build demo code for attack with timing data.

3. docker build -t cracktfhe/code2:v_0 . 				#to build image for demo code for attack with timing data.

4. docker run -it --rm=true cracktfhe/code2:v_0 /bin/bash 		#to build image for demo code for attack with timing data.

The entire process of cloning the repository and building the image takes around 20 to 25 minutes depending upon the system.

Once the Docker image is built and running, the demo can be run using the following set of commands in the given sequence:

This command generates the set of secret key and cloud key

1. gcc keygen.c -o keygen -ltfhe-spqlios-fma 		#keygen.c contains the code to generate the secret key. Please do not manipulate the given seed or the parameters as it will cause generation of incorrect results.

2. ./keygen				 		#creates a pair of secret key and cloud key. The cloud key is sent to the server, which consists of bootstrapping and keyswitch keys. The secret key is kept by the user and is used during encryption and decryption.

This command performs the overall error extraction and forms a system of equations using the same.

3. python obtain_error_using_decryption_failure.py 

This takes around 10 to 15 minutes to complete. In case the above command gets terminated before completion, please run the fourth command to clear out any temporary files created before running the third command again.

4. python clean_temporary_files.py

If the third command runs successfully, please run the fifth command to solve the system of equations created earlier and to obtain the secret key. The command automatically checks whether the obtained key is correct or not.

5. sage -python equation_solver.py

The above script uses SageMath 9.0 to perform Gaussian Elimination method of solving the system of equations.

The above demo runs on the pre-generated data stored in the following files:
1. template_error_clusters_for_NAND.txt			#It contains the template data generated by the server using a known key
2. testing_data_for_HomNAND_without_AVX.txt 		#It contains the testing data generated using a random key and random plaintext pairs.
3. secret_key_testing.txt 				#It contains the secret key used to generate the testing data. In a real-world scenario, it will not be known.

Apart from the above files and scripts, we have also provided below files under "additional_scripts" directory for reference purpose only:

1. boot-gates.cpp and lwe-functions.cpp- these are files from the TFHE library highlighting the modifications we have done during our experiments. Only the functions running on the server have been modified, which simulates the real-world scenario where the server is free to do so as well.
2. user_template_creation.c - this script is used to generate data for template creation phase.
3. user_testing.c - this script is used to generate data for testing purpose.
4. cloud_testing.c - this script is same during both template creation and testing phase. It runs a homomorphic NAND gate on the input ciphertexts.
5. verify_testing_unknown_plaintext.c - this scripts simulates the behaviour of the client during the attack phase. In case the provided "verify_testing" file does not work, the same can be regenerated using the command "gcc verify_testing_unknown_plaintext.c -o verify_testing -ltfhe-spqlios-fma". This requires TFHE library to be installed on the system using default settings.
